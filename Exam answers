Setting up personal directory:
To create personal directory in 'analysis test2' directory for exam 2:
```mkdir /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647```

***
### **Running fastqc**
Make directory to run fastqc:
```mkdir 1_fastqc``` ```cd 1_fastqc```

Create symbolic link to copy all 4 Solenopsis invicta datasets to your 1_fastqc directory:
ln -s ../../../raw_data/solenopsis_invicta_test2/*.fastq .
spack load fastqc
run fastqc to create a html and zip file for each dataset: fastqc *.fastq
Open another tab in your terminal for your personal terminal. Create a directory in your personal terminal named 'EPP622_Exam2' then secure copy html format into your personal terminal on your own device to copy html from your 1_fastqc directory to personal terminal: scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/1_fastqc/*html' ./
in personal terminal, open html file of choice: open SRR6922141_1_fastqc.html




Running Skewer
change directories so you are in your personal directory within 'analysis_test2' again and make a new directory to run skewer
cd ../
mkdir 2_skewer/
cd 2_skewer/
create symbloic link to import datasets into 2_skewer directory: ln -s ../../../raw_data/solenopsis_invicta_test2/*.fastq .
skewer is installed locally on sphinx so no need to spack load. However, we have multiple files we want to trim so we will create a for loop:
for f in *fastq
do
  BASE=$( basename $f | sed 's/_1.fastq//g')
  echo $BASE
  
  /sphinx_local/software/skewer/skewer \
  -t 2 -l 95 -Q 30 \
  -x AGATCGGAAGAGCGGTTCAGCAGGAATGCCGAGACCGATCTCGTATGCCGTCTTCTGCTTG \
  $f -o $BASE
done

In this loop, -t relates to number of threads used by this command, -l relates to minimum length of the sequences we wish to keep in the analysis, -Q realtes to the minimum mean quality score (Phred score) of the sequence across the entire length of the read. We are using Q30, which a a strict trimming threshold beacuase the data is already very high quality.
spack load fastqc. Run fastqc on your trimmed files to create html format to view: fastqc *-trimmed.fastq
ls -lh to verify the new trimmed html file formats you have
secure copy the html file formats into your personal terminal on your own device:
scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/2_skewer/*html' ./
can open html file by: open SRR#.trimmed.html



Read Mapping bwa version 0.7.17-spack find bwa
go back into your main directory and make new directory called 3_bwa ang then change into that directory: cd ../ mkdir 3_bwa cd 3_bwa
Now we will need to copy over our trimmed fastq read and solenopsis genome and index files. usually you run bwa index to index fasta file but that was already done for us. First, we want to make a directory within 3_bwa called 'solenopsis_test2_genome_index' mkdir solenopsis_genome_index then change into that directory cd solenopsis_test2_genome_index
we can copy the reference genome and indexes by creating a symbolic link: ln -s ../../../../raw_data/solenopsis_invicta/genome/UNIL_Sinv_3.0.fasta* . (i am using the original solenopsis_invicta/genome path becuase the one under solenopsis_test2 doesn't have the genome to soft link)
but for future reference, this is how you index a reference genome: 
bwa index <your_organism_ref_genome.fasta>

now change back into your 3_bwa directory cd ../ and symbolically link the trimmed fastq files from the 2_skewer directory: ln -s ../2_skewer/*-trimmed.fastq .
Now load bwa and samtools using spack. bwa outputs a SAM file (large) so we will convert it to a BAM file (smaller) by piping the SAM output into samtools to convert into BAM file
we will be running bwa using a for loop for multiple files
The script for the for loop will be written in nano named bwa.sh
for file in *.fastq
do
    basename=$(echo "$file" | sed 's/.fastq//')
    echo $file
    echo $basename

    spack load bwa
    spack load samtools@1.9%gcc@8.4.1

    bwa mem -t 6 \
    solenopsis_test2_genome_index/UNIL_Sinv_3.0.fasta \
    ${basename}.fastq \
    | samtools view -bSh \
    | samtools sort \
    -@ 3 -m 4G \
    -o ${basename}_sorted.bam


done
Control S to save and control X to exit nano
type: bash bwa.sh to run for loop to create sorted.bam files
directly form lab s reword: -t is used to specify the number of threads to run the job (bwa)
samtools view -bSh is used to convert the output from a SAM file to a BAM file with a header
-@ and -m designates the number of threads to run the job and memory per thread (samtools)
samtools@1.9%gcc@8.4.1 is the samtools version number
-bSh (tells bam this is a sam file
@ 3 is the amount of threads and 4G (4 gigs of memory)
3 threads total but 4G of memory is assigned to each thread so you're actually using 12G memory

Once the command stops running, you can extract stats from your sorted.bam file using samtools flagstat and output to a separate file.
spack load nano , spack load samtools@1.9%gcc@8.4.1, spack load bc%gcc@8.4.1
Create a for loop to process all files at once: named flagstat.sh, then type nano flagstat.sh to open and write script
for file in *-trimmed_sorted.bam
do
        basename=$(echo "$file" | sed 's/-trimmed_sorted.bam//')
        echo $file
        echo $basename

        samtools flagstat $basename-trimmed_sorted.bam > $basename-trimmed_sorted.stats
        echo $(cat $basename-trimmed.fastq | wc -l)/4 | bc
        echo $(cat $basename-trimmed_sorted.stats)

done
the samstools part of the loop creates an extracted sorted.stats file to view various statistics
the echo part of the loop with /4: Allyson-"Open up your sorted.stats file using cat to view various statistics. You may notice the % of reads mapped, and this value may be very high (>99% reads mapped). However, the percentage is wrong because bwa only counts reads that map to the reference as input reads.
To rectify this, we can use the bc calculator tool to calculate the total number of reads from our assigned fastq file, and use this as the denominator to calculate the correct % for mapped reads."
the echo part with the sorted.stats displays the supplemental info with the corrected reads all in one place
In the display of the results, you have:
SRR6922141-trimmed_sorted.bam
SRR6922141
1068311 (this is the correct number of mapped reads using bc calculator)
(this is all the .stats file info becfore using bc calc.)1071471 + 0 in total (QC-passed reads + QC-failed reads) 0 + 0 secondary 3160 + 0 supplementary 0 + 0 duplicates 1051910 + 0 mapped (98.17% : N/A) 0 + 0 paired in sequencing 0 + 0 read1 0 + 0 read2 0 + 0 properly paired (N/A : N/A) 0 + 0 with itself and mate mapped 0 + 0 singletons (N/A : N/A) 0 + 0 with mate mapped to a different chr 0 + 0 with mate mapped to a different chr (mapQ>=5)





GATK
Add Read Groups to BAM File so within your 3_bwa directory, do the following:
-Load java and samtools
spack load openjdk@11.0.8_10%gcc@8.4.1
spack load samtools@1.9
-Create for loop to use picard tools to add read groups and to index all samples: I named mine 'bam.sh'

for f in *-trimmed_sorted.bam
do
        BASE=$( basename $f | sed 's/-trimmed_sorted.bam*//g' )
        echo "BASE $BASE"

        java -jar /pickett_shared/software/picard-2.27.4/picard.jar \
                AddOrReplaceReadGroups \
                I=${BASE}-trimmed_sorted.bam \
                O=${BASE}-trimmed_sorted.RG.bam \
                RGSM=$BASE \
                RGLB=$BASE \
                RGPL=illumina \
                RGPU=$BASE
        samtools index ${BASE}-trimmed_sorted.RG.bam
done

I = input file (bam or sam)
O = output file (sam or bam or cram)
RGSM = Read-Group sample name Required.
RGLB = Read-Group library Required.
RGPL = Read-Group platform (e.g. ILLUMINA, SOLID) Required.
RGPU = Read-Group platform unit (eg. run barcode) Required.
We are cheating by using sample name for barcode, because it does not matter in our downstream analysis
Check size. If all looks good, you can now remove the original bam file. rm *_sorted.bam
GATK4 has a combined tool to mark and sort duplicates called MarkDuplicateSpark tool. The sorts and marks duplicates based on query name and is different from Picard MarkDuplicate tool as it is coordinate sorted. * We will not mark dups because of the data type*.

-GATK-still from lab 3
mkdir 4_gatk
cd 4_gatk
# Create a links to BAM file with read groups, its index, and the reference genome
ln -s ../3_bwa/<your_read_set>_sorted.RG.bam .
ln -s ../3_bwa/<your_read_set>_sorted.RG.bam.bai .
ln -s /pickett_shared/teaching/EPP622_Fall2022/raw_data/solenopsis_invicta/genome/UNIL_Sinv_3.0.fasta

-Prepare Reference for GATK
/pickett_shared/software/gatk-4.2.6.1/gatk CreateSequenceDictionary -R UNIL_Sinv_3.0.fasta
samtools faidx UNIL_Sinv_3.0.fasta
-Outputs a .dict file

Call SNPs and indels on all samples by making for loop to create vcf files for every samples:(nano vcf.sh)
for f in *-trimmed_sorted.RG.bam
do
        BASE=$( basename $f | sed 's/-trimmed_sorted.RG.bam*//g' )
        echo "BASE $BASE"

        /pickett_shared/software/gatk-4.2.6.1/gatk HaplotypeCaller \
        -R UNIL_Sinv_3.0.fasta \
        -I $BASE-trimmed_sorted.RG.bam \
        -O $BASE.vcf

done

Uses 4 threads by default.
But what we actually want to do is call the SNPs/indels using GVCF mode. This will allow us to later recall all the SNPs/indels using information combined across samples. We will also request a bam file with the realigned reads to view.
Example for loop: (nano gvcf.sh)
for f in *-trimmed_sorted.RG.bam
do
        BASE=$( basename $f | sed 's/-trimmed_sorted.RG.bam*//g' )
        echo "BASE $BASE"

        /pickett_shared/software/gatk-4.2.6.1/gatk HaplotypeCaller \
        -R UNIL_Sinv_3.0.fasta \
        -I $f \
        -O ${BASE}.g.vcf \
        -ERC GVCF \
        -bamout ${BASE}-trimmed_sorted.RG.realigned.bam

done
bash gatk.sh 

Compare the .vcf and the .g.vcf files. How are they different?-gvcf takes more storage and is slower but can make better variant calling then regular vcf
Copy your gvcf output file to a common directory: mkdir GVCFs, cd GVCFs, cp *.g.vcf GVCFs/, cd GVCFs
[lwy647@sphinx GVCFs]$ ls
SRR6922141.g.vcf  SRR6922185.g.vcf  SRR6922187.g.vcf  SRR6922236.g.vcf
[lwy647@sphinx GVCFs]$ pwd
/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/GVCFs

-IGV:
Copy these files to your computer
reference genome
reference genome index (*fai)
<your_read_set>_sorted.RG.bam
<your_read_set>_sorted.RG.bam.bai
<your_read_set>_sorted.RG.realigned.bam
<your_read_set>_sorted.RG.realigned.bam.bai
<your_read_set>.vcf
The following code in *****************************is what I typed in my personal terminal on my own device for the IGV part***
***sniece@sniecembpro Desktop % mkdir ants
sniece@sniecembpro Desktop % cd ants 
sniece@sniecembpro ants % ls
sniece@sniecembpro ants % scp lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*RG.bam .
zsh: no matches found: lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*RG.bam
sniece@sniecembpro ants % scp lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.bam .
zsh: no matches found: lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.bam
sniece@sniecembpro ants % scp lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*.bam .                  
zsh: no matches found: lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*.bam
sniece@sniecembpro ants % scp lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/SRR6922141-trimmed_sorted.RG.bam
usage: scp [-346ABCpqrTv] [-c cipher] [-F ssh_config] [-i identity_file]
            [-J destination] [-l limit] [-o ssh_option] [-P port]
            [-S program] source ... target
sniece@sniecembpro ants % ls
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.bam' .
lwy647@sphinx.ag.utk.edu's password: 
SRR6922141-trimmed_sorted.RG.bam                                              100%   53MB   1.9MB/s   00:28    
SRR6922185-trimmed_sorted.RG.bam                                              100%   54MB   3.8MB/s   00:14    
SRR6922187-trimmed_sorted.RG.bam                                              100%   55MB   3.9MB/s   00:14    
SRR6922236-trimmed_sorted.RG.bam                                              100%   41MB   2.6MB/s   00:15    
sniece@sniecembpro ants % ls
SRR6922141-trimmed_sorted.RG.bam	SRR6922187-trimmed_sorted.RG.bam
SRR6922185-trimmed_sorted.RG.bam	SRR6922236-trimmed_sorted.RG.bam
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.bam.bai' .
lwy647@sphinx.ag.utk.edu's password: 
SRR6922141-trimmed_sorted.RG.bam.bai                                          100%  600KB   2.0MB/s   00:00    
SRR6922185-trimmed_sorted.RG.bam.bai                                          100%  599KB   3.9MB/s   00:00    
SRR6922187-trimmed_sorted.RG.bam.bai                                          100%  599KB   4.9MB/s   00:00    
SRR6922236-trimmed_sorted.RG.bam.bai                                          100%  596KB   4.5MB/s   00:00    
sniece@sniecembpro ants % ls
SRR6922141-trimmed_sorted.RG.bam	SRR6922187-trimmed_sorted.RG.bam
SRR6922141-trimmed_sorted.RG.bam.bai	SRR6922187-trimmed_sorted.RG.bam.bai
SRR6922185-trimmed_sorted.RG.bam	SRR6922236-trimmed_sorted.RG.bam
SRR6922185-trimmed_sorted.RG.bam.bai	SRR6922236-trimmed_sorted.RG.bam.bai
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/UNIL_Sinv_3.0.fasta' .        
lwy647@sphinx.ag.utk.edu's password: 
UNIL_Sinv_3.0.fasta                                                           100%  365MB   4.5MB/s   01:21    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/UNIL_Sinv_3.0.fasta.fai' .
lwy647@sphinx.ag.utk.edu's password: 
UNIL_Sinv_3.0.fasta.fai                                                       100% 8040   337.6KB/s   00:00    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam.bai' .
lwy647@sphinx.ag.utk.edu's password: 
Permission denied, please try again.
lwy647@sphinx.ag.utk.edu's password: 
Permission denied, please try again.
lwy647@sphinx.ag.utk.edu's password: 
scp: /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam.bai: No such file or directory
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam.bai' .   
sniece@sniecembpro ants % ls
SRR6922141-trimmed_sorted.RG.bam	SRR6922187-trimmed_sorted.RG.bam.bai
SRR6922141-trimmed_sorted.RG.bam.bai	SRR6922236-trimmed_sorted.RG.bam
SRR6922185-trimmed_sorted.RG.bam	SRR6922236-trimmed_sorted.RG.bam.bai
SRR6922185-trimmed_sorted.RG.bam.bai	UNIL_Sinv_3.0.fasta
SRR6922187-trimmed_sorted.RG.bam	UNIL_Sinv_3.0.fasta.fai
sniece@sniecembpro ants % ls -la
total 1184072
drwxr-xr-x  12 sniece  staff        384 Oct  9 17:00 .
drwx------+ 24 sniece  staff        768 Oct  9 16:48 ..
-rw-r--r--   1 sniece  staff   55959360 Oct  9 16:56 SRR6922141-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     614232 Oct  9 16:57 SRR6922141-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   57068267 Oct  9 16:56 SRR6922185-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613384 Oct  9 16:57 SRR6922185-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   57491496 Oct  9 16:56 SRR6922187-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613768 Oct  9 16:57 SRR6922187-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   43045069 Oct  9 16:56 SRR6922236-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     610056 Oct  9 16:57 SRR6922236-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff  382857028 Oct  9 16:59 UNIL_Sinv_3.0.fasta
-rw-r--r--   1 sniece  staff       8040 Oct  9 17:00 UNIL_Sinv_3.0.fasta.fai
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam.bai' .
lwy647@sphinx.ag.utk.edu's password: 
scp: /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam.bai: No such file or directory
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*-trimmed_sorted.RG.realigned.bam' .    
lwy647@sphinx.ag.utk.edu's password: 
SRR6922141-trimmed_sorted.RG.realigned.bam                                    100%   16MB   7.2MB/s   00:02    
SRR6922185-trimmed_sorted.RG.realigned.bam                                    100%   13MB   8.6MB/s   00:01    
SRR6922187-trimmed_sorted.RG.realigned.bam                                    100%   16MB   7.7MB/s   00:02    
SRR6922236-trimmed_sorted.RG.realigned.bam                                    100%   10MB   8.1MB/s   00:01    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/*.vcf' .                            
lwy647@sphinx.ag.utk.edu's password: 
SRR6922141.g.vcf                                                              100%   32MB   5.7MB/s   00:05    
SRR6922141.vcf                                                                100% 6017KB   5.8MB/s   00:01    
SRR6922185.g.vcf                                                              100%   35MB   4.2MB/s   00:08    
SRR6922185.vcf                                                                100% 4594KB   5.1MB/s   00:00    
SRR6922187.g.vcf                                                              100%   34MB   4.3MB/s   00:08    
SRR6922187.vcf                                                                100% 5500KB   3.0MB/s   00:01    
SRR6922236.g.vcf                                                              100%   31MB   4.3MB/s   00:07    
SRR6922236.vcf                                                                100% 4218KB   4.1MB/s   00:01    
sniece@sniecembpro ants % ls -la
total 1622000
drwxr-xr-x  24 sniece  staff        768 Oct  9 17:07 .
drwx------+ 24 sniece  staff        768 Oct  9 16:48 ..
-rw-r--r--   1 sniece  staff   55959360 Oct  9 16:56 SRR6922141-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     614232 Oct  9 16:57 SRR6922141-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   16725237 Oct  9 17:06 SRR6922141-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff   33427260 Oct  9 17:07 SRR6922141.g.vcf
-rw-r--r--   1 sniece  staff    6161740 Oct  9 17:07 SRR6922141.vcf
-rw-r--r--   1 sniece  staff   57068267 Oct  9 16:56 SRR6922185-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613384 Oct  9 16:57 SRR6922185-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   13666699 Oct  9 17:06 SRR6922185-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff   36826124 Oct  9 17:07 SRR6922185.g.vcf
-rw-r--r--   1 sniece  staff    4704057 Oct  9 17:07 SRR6922185.vcf
-rw-r--r--   1 sniece  staff   57491496 Oct  9 16:56 SRR6922187-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613768 Oct  9 16:57 SRR6922187-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   16894378 Oct  9 17:06 SRR6922187-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff   35629870 Oct  9 17:07 SRR6922187.g.vcf
-rw-r--r--   1 sniece  staff    5632129 Oct  9 17:07 SRR6922187.vcf
-rw-r--r--   1 sniece  staff   43045069 Oct  9 16:56 SRR6922236-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     610056 Oct  9 16:57 SRR6922236-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   10841317 Oct  9 17:06 SRR6922236-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff   32231241 Oct  9 17:07 SRR6922236.g.vcf
-rw-r--r--   1 sniece  staff    4319435 Oct  9 17:07 SRR6922236.vcf
-rw-r--r--   1 sniece  staff  382857028 Oct  9 16:59 UNIL_Sinv_3.0.fasta
-rw-r--r--   1 sniece  staff       8040 Oct  9 17:00 UNIL_Sinv_3.0.fasta.fai
sniece@sniecembpro ants % rm *.g.vcf
sniece@sniecembpro ants % ls -la
total 1346512
drwxr-xr-x  20 sniece  staff        640 Oct  9 17:08 .
drwx------+ 24 sniece  staff        768 Oct  9 16:48 ..
-rw-r--r--   1 sniece  staff   55959360 Oct  9 16:56 SRR6922141-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     614232 Oct  9 16:57 SRR6922141-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   16725237 Oct  9 17:06 SRR6922141-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    6161740 Oct  9 17:07 SRR6922141.vcf
-rw-r--r--   1 sniece  staff   57068267 Oct  9 16:56 SRR6922185-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613384 Oct  9 16:57 SRR6922185-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   13666699 Oct  9 17:06 SRR6922185-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    4704057 Oct  9 17:07 SRR6922185.vcf
-rw-r--r--   1 sniece  staff   57491496 Oct  9 16:56 SRR6922187-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613768 Oct  9 16:57 SRR6922187-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   16894378 Oct  9 17:06 SRR6922187-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    5632129 Oct  9 17:07 SRR6922187.vcf
-rw-r--r--   1 sniece  staff   43045069 Oct  9 16:56 SRR6922236-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     610056 Oct  9 16:57 SRR6922236-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff   10841317 Oct  9 17:06 SRR6922236-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    4319435 Oct  9 17:07 SRR6922236.vcf
-rw-r--r--   1 sniece  staff  382857028 Oct  9 16:59 UNIL_Sinv_3.0.fasta
-rw-r--r--   1 sniece  staff       8040 Oct  9 17:00 UNIL_Sinv_3.0.fasta.fai
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/SRR6922236-trimmed_sorted.RG.realigned.bai' .
lwy647@sphinx.ag.utk.edu's password: 
SRR6922236-trimmed_sorted.RG.realigned.bai                                    100%  415KB 478.2KB/s   00:00    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/SRR6922187-trimmed_sorted.RG.realigned.bai' . 
lwy647@sphinx.ag.utk.edu's password: 
SRR6922187-trimmed_sorted.RG.realigned.bai                                    100%  468KB 269.4KB/s   00:01    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/SRR6922185-trimmed_sorted.RG.realigned.bai' .
lwy647@sphinx.ag.utk.edu's password: 
SRR6922185-trimmed_sorted.RG.realigned.bai                                    100%  429KB 950.1KB/s   00:00    
sniece@sniecembpro ants % scp 'lwy647@sphinx.ag.utk.edu:/pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/SRR6922141-trimmed_sorted.RG.realigned.bai' .
lwy647@sphinx.ag.utk.edu's password: 
SRR6922141-trimmed_sorted.RG.realigned.bai                                    100%  473KB   1.5MB/s   00:00    
sniece@sniecembpro ants % ls -la
total 1350184
drwxr-xr-x  24 sniece  staff        768 Oct  9 17:20 .
drwx------+ 24 sniece  staff        768 Oct  9 16:48 ..
-rw-r--r--   1 sniece  staff   55959360 Oct  9 16:56 SRR6922141-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     614232 Oct  9 16:57 SRR6922141-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff     484512 Oct  9 17:20 SRR6922141-trimmed_sorted.RG.realigned.bai
-rw-r--r--   1 sniece  staff   16725237 Oct  9 17:06 SRR6922141-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    6161740 Oct  9 17:07 SRR6922141.vcf
-rw-r--r--   1 sniece  staff   57068267 Oct  9 16:56 SRR6922185-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613384 Oct  9 16:57 SRR6922185-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff     438920 Oct  9 17:20 SRR6922185-trimmed_sorted.RG.realigned.bai
-rw-r--r--   1 sniece  staff   13666699 Oct  9 17:06 SRR6922185-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    4704057 Oct  9 17:07 SRR6922185.vcf
-rw-r--r--   1 sniece  staff   57491496 Oct  9 16:56 SRR6922187-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     613768 Oct  9 16:57 SRR6922187-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff     479616 Oct  9 17:19 SRR6922187-trimmed_sorted.RG.realigned.bai
-rw-r--r--   1 sniece  staff   16894378 Oct  9 17:06 SRR6922187-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    5632129 Oct  9 17:07 SRR6922187.vcf
-rw-r--r--   1 sniece  staff   43045069 Oct  9 16:56 SRR6922236-trimmed_sorted.RG.bam
-rw-r--r--   1 sniece  staff     610056 Oct  9 16:57 SRR6922236-trimmed_sorted.RG.bam.bai
-rw-r--r--   1 sniece  staff     425168 Oct  9 17:19 SRR6922236-trimmed_sorted.RG.realigned.bai
-rw-r--r--   1 sniece  staff   10841317 Oct  9 17:06 SRR6922236-trimmed_sorted.RG.realigned.bam
-rw-r--r--   1 sniece  staff    4319435 Oct  9 17:07 SRR6922236.vcf
-rw-r--r--   1 sniece  staff  382857028 Oct  9 16:59 UNIL_Sinv_3.0.fasta
-rw-r--r--   1 sniece  staff       8040 Oct  9 17:00 UNIL_Sinv_3.0.fasta.fai
*************
View on the online IGV. (igv.org/app in your browser)
In order to view online at IGV, you need to spack load nano, nano SRR6922141.vcf, find a read where vcf calls a SNP, grep to show only that line for easier viewing: grep 'NC_052664.1\s1051130' SRR6922141.vcf
NC_052664.1	1051130	.	G	A	643.06	.	AC=2;AF=1.00;AN=2;DP=15;ExcessHet=0.0000;FS=0.000;MLEAC=2;MLEAF=1.00;MQ=60.00;QD=29.52;SOR=5.549	GT:AD:DP:GQ:PL	1/1:0,15:15:45:657,45,0, then in IGV you upload you reference genome of UNIL_Sinv_3.0.fasta & UNIL_Sinv_3.0.fasta.fai in top left where it says genome then select local file for those two reference genomes, then you need to select tracks at the top then local file to upload the .bam files then the .realigned.bam files. Then in the search bar, type NC_#:location of SNP and IGV will display that particular SNP.



-Combine and recall SNPs across the whole group of samples
mkdir 5_gatk_combine
cd 5_gatk_combine/
ln -s /pickett_shared/teaching/EPP622_Fall2022/raw_data/solenopsis_invicta/genome/UNIL_Sinv_3.0.fasta
ln -s ../4_gatk/UNIL_Sinv_3.0.fasta.fai
ln -s ../4_gatk/UNIL_Sinv_3.0.dict .

Lets look at how many samples we have.
[lwy647@sphinx 5_gatk_combine]$ ls /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/GVCFs
SRR6922141.g.vcf  SRR6922185.g.vcf  SRR6922187.g.vcf  SRR6922236.g.vcf
[lwy647@sphinx 5_gatk_combine]$ ln -s /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/GVCFs/*g.vcf .
[lwy647@sphinx 5_gatk_combine]$ ls
SRR6922141.g.vcf  SRR6922185.g.vcf  SRR6922187.g.vcf  SRR6922236.g.vcf  UNIL_Sinv_3.0.dict  UNIL_Sinv_3.0.fasta  UNIL_Sinv_3.0.fasta.fai


CombineGVCFs wants every individual gvcf listed in a specific way with its own parameter flag
ln -s /pickett_shared/teaching/EPP622_Fall2022/analysis_test2/lwy647/4_gatk/GVCFs/*g.vcf .
[lwy647@sphinx 5_gatk_combine]$ echo "/pickett_shared/software/gatk-4.2.6.1/gatk CombineGVCFs \\
> -R UNIL_Sinv_3.0.fasta \\"
/pickett_shared/software/gatk-4.2.6.1/gatk CombineGVCFs \
-R UNIL_Sinv_3.0.fasta \

[lwy647@sphinx 5_gatk_combine]$ ls *g.vcf >list.txt
[lwy647@sphinx 5_gatk_combine]$ mv list.txt gvcfs.list
[lwy647@sphinx 5_gatk_combine]$ cat gvcfs.list
SRR6922141.g.vcf
SRR6922185.g.vcf
SRR6922187.g.vcf
SRR6922236.g.vcf

[lwy647@sphinx 5_gatk_combine]$ /pickett_shared/software/gatk-4.2.6.1/gatk CombineGVCFs \
> -R UNIL_Sinv_3.0.fasta \
> -variant gvcfs.list -O solenopsis_combined.g.vcf.gz

[lwy647@sphinx 5_gatk_combine]$ /pickett_shared/software/gatk-4.2.6.1/gatk --java-options "-Xmx10g" GenotypeGVCFs \
> -R UNIL_Sinv_3.0.fasta  \
>    -V solenopsis_combined.g.vcf.gz \
>    -O solenopsis_combined.vcf.gz

[lwy647@sphinx 5_gatk_combine]$ spack load bcftools
[lwy647@sphinx 5_gatk_combine]$ ls
gvcfs.list                        solenopsis_combined.vcf.gz      SRR6922185.g.vcf  UNIL_Sinv_3.0.dict
solenopsis_combined.g.vcf.gz      solenopsis_combined.vcf.gz.tbi  SRR6922187.g.vcf  UNIL_Sinv_3.0.fasta
solenopsis_combined.g.vcf.gz.tbi  SRR6922141.g.vcf                SRR6922236.g.vcf  UNIL_Sinv_3.0.fasta.fai
bcftools stats solenopsis_combined.vcf.gz > solenopsis_combined.vcf.stats.txt
nano solenopsis_combined.vcf.stats.txt to look at combined number of SNPs and indels
These SNPs are unfiltered and probably have many false positives. The next recommended step is variant quality score recalibration (VQSR), however, that depends on high-quality sets of known variants to use as training. We don't have that, so we will do some hard threshold filtering
SN      0       number of samples:      4
SN      0       number of records:      59869
SN      0       number of no-ALTs:      0
SN      0       number of SNPs: 52557
SN      0       number of MNPs: 0
SN      0       number of indels:       7442
SN      0       number of others:       0
SN      0       number of multiallelic sites:   1235
SN      0       number of multiallelic SNP sites:       137

TO look at how many snps we have for each individual sample:
cd ../4_gatk
spack load bcftools
bcftools stats samplename.vcf > samplename.vcf.stats.txt
grep 'number of SNPs:' *stats.txt
SRR6922141.vcf.stats.txt:SN	0	number of SNPs:	27332
SRR6922185.vcf.stats.txt:SN	0	number of SNPs:	19653
SRR6922187.vcf.stats.txt:SN	0	number of SNPs:	25630
SRR6922236.vcf.stats.txt:SN	0	number of SNPs:	18112
[lwy647@sphinx 4_gatk]$ grep 'number of indels:' *stats.txt
SRR6922141.vcf.stats.txt:SN	0	number of indels:	3838
SRR6922185.vcf.stats.txt:SN	0	number of indels:	3159
SRR6922187.vcf.stats.txt:SN	0	number of indels:	3466
SRR6922236.vcf.stats.txt:SN	0	number of indels:	2955

Here are recommended filtering parameters from GATK with more explanation here. We don't have time but you would ideally split out indels and snps, then apply independent filters as described in the article.
/pickett_shared/software/gatk-4.2.6.1/gatk VariantFiltration \
        -R UNIL_Sinv_3.0.fasta  \
        -V solenopsis_combined.vcf.gz \
        -O solenopsis_combined.GATKfilters.vcf.gz \
        -filter-name "QD_filter" -filter "QD < 2.0" \
        -filter-name "FS_filter" -filter "FS > 60.0" \
        -filter-name "MQ_filter" -filter "MQ < 40.0" \
        -filter-name "SOR_filter" -filter "SOR > 4.0" \
        -filter-name "MQRankSum" -filter "MQRankSum < -12.5" \
        -filter-name "ReadPosRankSum" -filter "ReadPosRankSum < -8.0" 
After it runs, should have solenopsis_combined.GATKfilters.vcf
        
The latter two give a warning, but its still working fine according to the GATK forum.
QD = QualByDepth
FS = FisherStrand - filter for strand bias
SOR = StrandOddsRatio
MQ = RMSMappingQuality
MQRankSum = MappingQualityRankSumTest
ReadPosRankSum

Use bcftools stats to look at your filtered files. how are they different from the unfiltered and from each ohter? The tool only marks sites that do not pass, it does not remove them from the file. So lets get stats on only passing variants
bcftools stats -f "PASS,." solenopsis_combined.GATKfilters.vcf.gz >solenopsis_combined.GATKfilters.vcf.stats.txt
grep 'number of SNPs:' *stats.txt
grep 'number of indels:' *stats.txt


















